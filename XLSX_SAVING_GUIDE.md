# Руководство по сохранению файлов в формате XLSX

## Обзор изменений

Теперь система LuckySheet сохраняет файлы в формате XLSX вместо JSON, что обеспечивает лучшую совместимость с Microsoft Excel и другими табличными редакторами.

## Основные улучшения

### 1. Сохранение в формате XLSX
- Файлы теперь сохраняются в стандартном формате XLSX
- Полная совместимость с Microsoft Excel, LibreOffice Calc, Google Sheets
- Сохранение всех стилей, форматирования и формул

### 2. Предотвращение потери данных
- Реализована функция `getFullData()` для получения полных данных
- Автоматическое сохранение каждые 30 секунд
- Сохранение при закрытии страницы
- Сохранение всех метаданных (конфигурация, графики, изображения)

### 3. Улучшенная обработка данных
- Поддержка различных форматов данных
- Автоматическое преобразование между форматами
- Сохранение в Dropbox в формате XLSX

## Новые функции

### Автоматическое сохранение
```javascript
// Автосохранение каждые 30 секунд
setInterval(() => {
  if (isInitialized.value) {
    autoSave()
  }
}, 30000)

// Автосохранение при закрытии страницы
window.addEventListener('beforeunload', () => {
  if (isInitialized.value) {
    autoSave()
  }
})
```

### Получение полных данных
```javascript
// Получение всех данных с сохранением изменений
const fullData = getFullData()
```

### Сохранение в XLSX
```javascript
// Сохранение файла в формате XLSX
await saveAsXLSX(fullData.sheets, fileName)
```

## Структура данных

### Полная структура данных
```javascript
{
  sheets: [...],           // Массив листов
  config: {...},           // Конфигурация
  calcChain: [...],        // Цепочка вычислений
  chart: [...],            // Графики
  image: [...],            // Изображения
  timestamp: "..."         // Временная метка
}
```

### Структура листа
```javascript
{
  name: "Sheet1",
  data: [...],             // Данные ячеек
  config: {
    merge: {...},          // Объединения ячеек
    borderInfo: [...]      // Границы
  },
  // ... другие свойства
}
```

## Использование

### Сохранение файла
1. Нажмите кнопку "Сохранить" в панели инструментов
2. Файл будет сохранен в формате XLSX
3. Также будет создана резервная копия в localStorage

### Сохранение в облако
1. Нажмите кнопку "В облако" в панели инструментов
2. Файл будет сохранен локально в XLSX и загружен в Dropbox
3. Убедитесь, что Dropbox подключен в настройках

### Скачивание файла
1. Нажмите кнопку "Скачать" в панели инструментов
2. Файл будет скачан в формате XLSX
3. Можно открыть в любом совместимом редакторе

## Совместимость

### Поддерживаемые форматы
- ✅ XLSX (основной формат)
- ✅ XLS (при загрузке)
- ✅ JSON (для обратной совместимости)

### Поддерживаемые редакторы
- ✅ Microsoft Excel
- ✅ LibreOffice Calc
- ✅ Google Sheets
- ✅ Numbers (macOS)
- ✅ WPS Office

## Устранение неполадок

### Проблема: Данные не сохраняются
**Решение:** Проверьте, что LuckySheet инициализирован и функция `getFullData()` работает корректно.

### Проблема: Файл не открывается в Excel
**Решение:** Убедитесь, что файл сохранен с расширением `.xlsx` и использует правильный MIME-тип.

### Проблема: Потеря форматирования
**Решение:** Используйте функцию `getFullData()` для получения всех данных, включая стили и форматирование.

## Технические детали

### Новые утилиты
- `src/utils/xlsxStorage.js` - Основная утилита для работы с XLSX
- `saveAsXLSX()` - Функция сохранения в XLSX
- `getFullLuckySheetData()` - Функция получения полных данных

### Обновленные компоненты
- `App.vue` - Обновлена логика сохранения
- `LuckySheet.vue` - Добавлено автосохранение
- `FileManager.vue` - Поддержка XLSX файлов
- `dropboxStorage.js` - Поддержка XLSX в облаке

### Автоматическое сохранение
- Каждые 30 секунд
- При закрытии страницы
- При потере фокуса
- При явном сохранении

## Заключение

Новая система сохранения обеспечивает:
- ✅ Сохранение в стандартном формате XLSX
- ✅ Предотвращение потери данных
- ✅ Автоматическое сохранение
- ✅ Полную совместимость с Excel
- ✅ Сохранение всех стилей и форматирования 